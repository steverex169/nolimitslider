<h2>Chat with {{ chat.user_name|default:"Guest" }}</h2>

<div id="chat-box" style="border:1px solid #ccc; height:300px; overflow-y:scroll; padding:10px;">
</div>

<input type="text" id="msg" placeholder="Type message">
<button onclick="sendMessage()">Send</button>

<script>
function loadMessages() {
  fetch("/agent/chat/{{ chat.session_id }}/messages/")
    .then(res => res.json())
    .then(data => {
      let box = document.getElementById("chat-box");
      box.innerHTML = "";
      data.forEach(m => {
        box.innerHTML += `<p><b>${m.sender}:</b> ${m.content}</p>`;
      });
      box.scrollTop = box.scrollHeight;
    });
}

function sendMessage() {
  let msg = document.getElementById("msg").value;
  if (!msg.trim()) return;
  fetch("/agent/chat/{{ chat.session_id }}/send/", {
    method: "POST",
    headers: {"X-CSRFToken": "{{ csrf_token }}"},
    body: new URLSearchParams({"content": msg})
  }).then(res => res.json()).then(data => {
    document.getElementById("msg").value = "";
    loadMessages();
  });
}

setInterval(loadMessages, 2000);
loadMessages();
</script>
