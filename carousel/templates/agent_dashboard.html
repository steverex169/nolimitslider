<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f7;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background: #222;
      color: #fff;
      display: flex;
      flex-direction: column;
      padding-top: 20px;
      overflow-y: auto;
    }

    .sidebar h2 {
      text-align: center;
      font-size: 18px;
      margin-bottom: 20px;
    }

    .sidebar a {
      color: #fff;
      padding: 12px 20px;
      text-decoration: none;
      display: block;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }

    .sidebar a:hover {
      background: #444;
    }

    .dropdown-content {
      display: none;
      flex-direction: column;
      background: #333;
    }

    .dropdown-content a,
    .dropdown-content span {
      padding: 10px 20px;
      font-size: 14px;
      color: #ccc;
      display: block;
    }

    .dropdown-content a:hover {
      background: #555;
      color: #fff;
    }

    /* Main content */
    .main {
      margin-left: 220px;
      padding: 20px;
    }

    .status-toggle {
      margin: 10px 0;
    }

    .summary {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    .summary div {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      flex: 1;
      text-align: center;
    }

    .summary div h3 {
      margin: 0;
      font-size: 16px;
      color: #555;
    }

    .summary div p {
      margin: 5px 0 0;
      font-size: 20px;
      font-weight: bold;
      color: #222;
    }

    /* Chat panel */
    .chat-panel {
      margin-top: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      height: 500px;
    }

    .chat-header {
      padding: 12px 20px;
      background: #111;
      color: #fff;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 10px 10px 0 0;
    }

    .chat-header form button {
      background: #D911BD;
      color: #fff;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    .chat-header form button:hover {
      background: #b30fa0;
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #f0f0f5;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message-bubble {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 20px;
      position: relative;
      word-wrap: break-word;
    }

    .message-bubble.user {
      background: #e0e0e0;
      align-self: flex-start;
    }

    .message-bubble.agent {
      background: #D911BD;
      color: #fff;
      align-self: flex-end;
    }

    .message-bubble:hover {
      opacity: 0.9;
      transition: 0.2s;
    }

    .chat-input {
      display: flex;
      border-top: 1px solid #ccc;
    }

    .chat-input input {
      flex: 1;
      padding: 12px 15px;
      border: none;
      outline: none;
      border-radius: 0;
    }

    .chat-input button {
      padding: 12px 20px;
      border: none;
      background: #D911BD;
      color: #fff;
      cursor: pointer;
    }

    .chat-input button:hover {
      background: #b30fa0;
    }

    /* FAQ styling inside .main */
    #success-alert,
    #error-alert {
      display: none;
      margin-bottom: 10px;
    }

    #faq-list tr:hover {
      background-color: #f1f1f1;
    }

    #add-faq-form input,
    #add-faq-form textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    #add-faq-form button {
      background: #28a745;
      color: #fff;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
    }

    #add-faq-form button:hover {
      background: #218838;
    }
  </style>
</head>

<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Agent Dashboard</h2>

    <a onclick="toggleDropdown('chat-dropdown')">üí¨ Chats ‚ñæ</a>
    <div id="chat-dropdown" class="dropdown-content">
      <strong style="padding: 10px 20px; color:#fff;">Active Chats</strong>
      {% for s in active_chats %}
      <a href="?chat={{ s.session_id }}" onclick="resetMessageCounter()">
        {{ s.session_id }}
      </a>
      {% empty %}
      <span>No active chats</span>
      {% endfor %}

      <strong style="padding: 10px 20px; color:#bbb;">New Chats</strong>
      {% for s in new_chats %}
      <a href="?chat={{ s.session_id }}" onclick="resetMessageCounter()">
        {{ s.session_id }}
      </a>
      {% empty %}
      <span>No new chats</span>
      {% endfor %}
    </div>

    <!-- FAQs -->
    <a href="javascript:void(0);" onclick="loadFAQs()">‚ùì FAQs</a>
  </div>

  <!-- Main content -->
  <div class="main">
    <h2>Welcome, {{ request.user.username }}</h2>

    <!-- Status -->
    <div class="status-toggle">
      Current Status:
      {% if status.is_online %}
      <span style="color:green;">üü¢ Online</span>
      <form method="post" style="display:inline;" action="{% url 'set_online' %}">
        {% csrf_token %}
        <button type="submit" name="action" value="go_offline">Go Offline</button>
      </form>
      {% else %}
      <span style="color:red;">üî¥ Offline</span>
      <form method="post" style="display:inline;" action="{% url 'set_online' %}">
        {% csrf_token %}
        <button type="submit" name="action" value="go_online">Go Online</button>
      </form>
      {% endif %}
    </div>

    <!-- Summary cards -->
    <div class="summary">
      <div>
        <h3>Total Chats</h3>
        <p>{{ total_chats }}</p>
      </div>
      <div>
        <h3>Active Chats</h3>
        <p>{{ active_chats|length }}</p>
      </div>
      <div>
        <h3>New Chats</h3>
        <p>{{ new_chats|length }}</p>
      </div>
    </div>

    <!-- Chat Panel -->
    {% if selected_chat %}
    <div class="chat-panel">
      <div class="chat-header">
        <span>Chat with {{ selected_chat.user_name|default:"Guest" }}</span>
        <div style="margin:10px 0;">
          <label>
            <input type="checkbox" id="sound-toggle" checked>
            Enable Notification Sound
          </label>
        </div>
        {% if not selected_chat.closed %}
        <form method="post" action="{% url 'close_chat' selected_chat.session_id %}" style="margin:0;">
          {% csrf_token %}
          <button type="submit">Close Chat</button>
        </form>
        {% else %}
        <span style="color:gray; font-size:12px;">This chat is closed</span>
        {% endif %}
      </div>

      <div class="chat-messages" id="chat-box"></div>

      <div class="chat-input">
        <input type="text" id="msg" placeholder="Type a message" {% if selected_chat.closed %}disabled{% endif %}>
        <button onclick="sendMessage()" {% if selected_chat.closed %}disabled{% endif %}>
          Send
        </button>
      </div>
    </div>
    {% else %}
    <p>Select a chat from the sidebar to start messaging.</p>
    {% endif %}
  </div>

  <audio id="notification-sound" src="https://www.myinstants.com/media/sounds/notification.mp3" preload="auto"></audio>

  <!-- JS -->
  <script>
    // Sidebar dropdown
    function toggleDropdown(id) {
      let el = document.getElementById(id);
      el.style.display = el.style.display === "block" ? "none" : "block";
    }

    // ===== Chat & messages =====
    {% if selected_chat %}
    let lastMessageCount = null;

    function loadMessages() {
      fetch("/agent/chat/{{ selected_chat.session_id }}/messages/")
        .then(res => res.json())
        .then(data => {
          const clientMessages = data.filter(m => m.sender === "client").length;
          if (lastMessageCount !== null && clientMessages > lastMessageCount) {
            if (document.getElementById("sound-toggle").checked) {
              document.getElementById("notification-sound").play().catch(() => { });
            }
          }
          const box = document.getElementById("chat-box");
          box.innerHTML = "";
          data.forEach(m => {
            const cls = m.sender === "agent" ? "agent" : "user";
            box.innerHTML += `<div class="message-bubble ${cls}">${m.content}</div>`;
          });
          box.scrollTop = box.scrollHeight;
          lastMessageCount = clientMessages;
        });
    }

    function resetMessageCounter() {
      lastMessageCount = null;
    }

    setInterval(loadMessages, 2000);
    loadMessages();

    let typingTimer = null;
    let isTyping = false;

    function setTyping(state) {
      fetch("/chat/set-typing/", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({ typing: state })
      }).catch(() => { });
    }

    function handleTyping() {
      const msgInput = document.getElementById("msg");
      const value = msgInput.value.trim();
      if (value.length > 0 && !isTyping) { setTyping(true); isTyping = true; }
      if (value.length === 0 && isTyping) { setTyping(false); isTyping = false; }
      clearTimeout(typingTimer);
      if (value.length > 0) { typingTimer = setTimeout(() => { setTyping(false); isTyping = false; }, 3600000); }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const msgInput = document.getElementById("msg");
      if (msgInput) msgInput.addEventListener("input", handleTyping);
    });

    function sendMessage() {
      let msg = document.getElementById("msg").value.trim();
      if (!msg) return;
      fetch("/agent/chat/{{ selected_chat.session_id }}/send/", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        body: new URLSearchParams({ content: msg })
      }).then(() => { document.getElementById("msg").value = ""; isTyping = false; clearTimeout(typingTimer); loadMessages(); });
    }
    {% endif %}

    // ===== FAQ management =====
    function loadFAQs() {
      console.log("Loading FAQs...");

      fetch("{% url 'faq_dashboard' %}?ajax=1")
        .then(res => {
          if (!res.ok) {
            throw new Error("Network response was not ok");
          }
          console.log("Successfully fetched FAQ HTML content");
          return res.text();
        })
        .then(html => {
          // Replace main content
          document.querySelector(".main").innerHTML = html;
          console.log("Main content updated with FAQ data");

          // Re-select necessary elements after replacing innerHTML
          const form = document.getElementById('add-faq-form');
          const successAlert = document.getElementById('success-alert');
          const errorAlert = document.getElementById('error-alert');
          const faqList = document.getElementById('faq-list');

          if (!form) {
            console.warn("‚ùå FAQ form not found!");
            return;
          }

          console.log("‚úÖ FAQ form loaded");

          // Attach submit handler
          form.addEventListener('submit', function (e) {
            e.preventDefault();
            console.log("Form submitted");

            const formData = new FormData(form);

            fetch(form.action, {
              method: 'POST',
              headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: formData
            })
              .then(res => {
                if (!res.ok) {
                  throw new Error("Failed to submit form");
                }
                console.log("POST response received, status: 200");
                return res.json();
              })
              .then(data => {
                console.log("Response JSON:", data);

                if (data.success) {
                  console.log("‚úÖ FAQ successfully added");

                  // Show success alert (force display block)
                  successAlert.style.display = "block";
                  errorAlert.style.display = "none";

                  // Hide success alert after 10 seconds
                  setTimeout(() => successAlert.style.display = "none", 10000);

                  // Reset the form fields
                  form.reset();

                  // Append new FAQ row
                  const newRow = document.createElement('tr');
                  newRow.innerHTML = `
                                <td class="fw-medium">${data.faq.question}</td>
                                <td>${data.faq.answer}</td>
                                <td>
                                    <form method="post" action="/faqs/delete/${data.faq.id}/" style="display:inline;">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${formData.get('csrfmiddlewaretoken')}">
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?');">üóë Delete</button>
                                    </form>
                                </td>`;
                  faqList.appendChild(newRow);
                } else {
                  console.warn("‚ùå Error adding FAQ:", data.error);
                  successAlert.style.display = "none";
                  errorAlert.style.display = "block";
                  errorAlert.innerText = data.error || 'Failed to add FAQ';
                }
              })
              .catch(err => {
                console.error("‚ùå AJAX error:", err);
                successAlert.style.display = "none";
                errorAlert.style.display = "block";
                errorAlert.innerText = 'Server error: could not save FAQ';
              });
          });
        })
        .catch(err => {
          console.error("Failed to load FAQs:", err);
        });
    }

  </script>

</body>

</html>